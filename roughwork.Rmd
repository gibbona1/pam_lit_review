---
title: "Passive Acoustic Monitoring Lit Review"
output: html_notebook
---

##Dataset size by year

```{r}
library(ggplot2)
library(maps)
library(dplyr)
```

```{r}
df <- read.csv("tagged_literature.csv")
#df$Year <- as.factor(df$Year)

p <- df |>
  tidyr::drop_na(Dataset_GB) |> 
  #filter(Year >= 2008) |>
  ggplot(aes(Year, Dataset_GB)) + 
  geom_point() + 
  scale_y_log10() +
  geom_smooth(method="lm", color = "dodgerblue")
p
ggsave("images/data_trend.png", p, width = 240, height = 100, units = "mm")
```

```{r}
# Sample data
#coords <- c("-0.356251N,12.940863E;-0.078775N,15.127076E", "-0.078775N,15.1270777E")

# Function to convert coordinates to numeric values
convert_to_numeric <- function(coord_string) {
  # Split the string by comma
  parts <- strsplit(coord_string, ",")[[1]]
  #remove leading or trailing space
  
  # Extract latitude and longitude, handle direction
  lat <- as.numeric(gsub("[A-Z]", "", parts[1]))
  lon <- as.numeric(gsub("[A-Z]", "", parts[2]))
  
  # Check direction for latitude
  if (grepl("S", parts[1])) {
    lat <- -lat
  }
  
  # Check direction for longitude
  if (grepl("W", parts[2])) {
    lon <- -lon
  }
  
  return(paste0(c(lat, lon), collapse = ","))
}

latlong_df <- df |>
  select(latlong, Ecosystem) |>
  mutate(latlong = strsplit(latlong, ";")) |>
  tidyr::unnest(latlong) |>
  mutate(Ecosystem = strsplit(Ecosystem, ", ")) |>
  tidyr::unnest(Ecosystem) |>
  mutate(latlong = sapply(latlong, convert_to_numeric),
         lat = sapply(strsplit(latlong, ","), function(x) as.numeric(x[1])),
         long = sapply(strsplit(latlong, ","), function(x) as.numeric(x[2]))
)
latlong_df
```


```{r}
# Create the world map
world <- map_data("world")

# Plotting
p <- ggplot() +
  # Add world map
  geom_polygon(data = world, aes(x = long, y = lat, group = group), fill = "lightgray", color = "white") +
  # Add points for different tags
  geom_jitter(data = latlong_df, aes(x = long, y = lat, colour=Ecosystem), size = 3) +
  # Set coordinate system to map projection
  coord_fixed(ratio = 1) +
  # Add labels and title
  labs(title = "Global Distribution of Species",
       x = "Longitude",
       y = "Latitude") +
  # Theme settings
  theme_minimal() +
  theme(panel.grid.major = element_line(color = "grey80"),
        panel.grid.minor = element_blank(),
        axis.text.x = element_text(angle = 0, hjust = 0.5),
        legend.position = "right")
p
ggsave("images/ecosystem_map.png", p, width = 240, height = 100, units = "mm")
```

```{r}
include_missing_zero <- function(df, col){
  missing_years <- 2005:2024  # This creates c(2025, 2024)

  new_rows <- expand.grid(
    Year  = missing_years,  
    a     = df |> pull({{col}}) |> unique(), 
    Count = 0
  )
  
  colnames(new_rows)[2] <- col

  df <- df |>
    bind_rows(new_rows) |>
    distinct() 
  return(df)
}

keep_gt1 <- function(df, col){
  total_counts <- df |>
    group_by(.data[[col]]) |>
    summarise(Total_Count = n(), .groups = 'drop') |>
    na.omit()

  methods_to_keep <- total_counts |>
    filter(Total_Count > 1) |>
    pull({{ col }})
    
  df[,col] <- ifelse(df[[col]] %in% methods_to_keep, df[[col]], "Other Methods")
  return(df)
}

barplot_counts <- function(df, col, col_title=col){
  count_data <- df |>
    group_by(Year, .data[[col]], .drop=FALSE) |>
    summarise(Count = n(), .groups = 'drop') |>
    na.omit()
  
  total_count_per_year <- count_data |>
    group_by(Year, .drop=FALSE) |>
    summarise(Total = sum(Count), .groups = 'drop')
  
  count_data <- left_join(count_data, total_count_per_year, by = "Year") |>
    mutate(Percentage = (Count / Total) * 100) |>
    include_missing_zero(col)

  p <- count_data |> 
    ggplot(aes(x = factor(Year), y = Count, fill = .data[[col]])) +
    geom_bar(stat = "identity", colour=ifelse(count_data$Count > 0, "black", NA)) +
    labs(x = "Year", y = "Count", fill = col_title) +
    scale_y_continuous(expand=c(0,0))+
    theme_minimal() +
    guides(fill = guide_legend(override.aes = list(colour = "black")))+
    theme(panel.grid.major.x = element_blank(),
          panel.grid.major.y = element_line(colour = "grey80"),
          axis.line.x = element_line(colour="black"),
          axis.ticks.x=element_line())
  return(p)
}
```

```{r}
# Convert 'NA' to R's NA
df$Analysis[df$Analysis == "NA"] <- NA

p <- barplot_counts(df, "Analysis")
p
ggsave("images/analysis_year.png", p, width = 240, height = 100, units = "mm")
```
```{r}
p <- df |>
  mutate(Reported_value = as.numeric(Reported_value)) |>
  tidyr::drop_na(Reported_value) |>
  ggplot(aes(x = Analysis, y = Reported_value)) +
  geom_boxplot()
p
ggsave("images/analysis_reportedvalue.png", p, width = 240, height = 100, units = "mm")
```

```{r}
p <- df |>
  mutate(Reported_value = as.numeric(Reported_value)) |>
  tidyr::drop_na(Reported_value) |>
  mutate(Decade = case_when(
    Year >= 2000 & Year < 2010 ~ "2000s",
    Year >= 2010 & Year < 2020 ~ "2010s",
    Year >= 2020 & Year < 2030 ~ "2020s",
    TRUE ~ NA_character_  # Handle years outside these ranges
  )) |>
  ggplot(aes(x = Decade, y = Reported_value)) +
  geom_boxplot()
p
ggsave("images/decade_reportedvalue.png", p, width = 240, height = 100, units = "mm")
```

```{r}
p <- df |>
  mutate(Reported_value = as.numeric(Reported_value)) |>
  tidyr::drop_na(Reported_value) |>
  mutate(Taxa = strsplit(as.character(Taxa), ", ")) |>
  tidyr::unnest(Taxa) |>
  ggplot(aes(y = Reported_value)) +
  geom_boxplot() +
  facet_wrap(~Taxa)
p
ggsave("images/taxa_reportedvalue.png", p, width = 240, height = 100, units = "mm")
```


```{r}
# Convert 'NA' to R's NA
df$Prog..language[df$Prog..language == "NA"] <- NA

# Split languages where there are multiple
df_lang <- df |>
  mutate(ProgLanguage = strsplit(as.character(Prog..language), ", ")) |>
  tidyr::unnest(ProgLanguage)

p <- barplot_counts(df_lang, "ProgLanguage", "Programming Language")
p
ggsave("images/programminglanguage_year.png", p, width = 240, height = 100, units = "mm")
```

```{r}
df_taxa <- df |>
  mutate(Taxa = strsplit(as.character(Taxa), ", ")) |>
  tidyr::unnest(Taxa)

p <- barplot_counts(df_taxa, "Taxa")
p
ggsave("images/taxa_year.png", p, width = 240, height = 100, units = "mm")
```
```{r}
df_analysis <- df |>
  mutate(Analysis.Methods = strsplit(as.character(Analysis.Methods), ", ")) |>
  tidyr::unnest(Analysis.Methods)

df_analysis <- keep_gt1(df_analysis, "Analysis.Methods")
  #filter(Analysis.Methods %in% methods_to_keep)
p <- barplot_counts(df_analysis, "Analysis.Methods")
p
ggsave("images/analysismethods_year.png", p, width = 240, height = 100, units = "mm")
```
```{r}
df_tools <- df |>
  mutate(Automation.Tools = strsplit(as.character(Automation.Tools), ", ")) |>
  tidyr::unnest(Automation.Tools)

df_tools <- keep_gt1(df_tools, "Automation.Tools")
  #filter(Analysis.Methods %in% methods_to_keep)
p <- barplot_counts(df_tools, "Automation.Tools")
p
ggsave("images/automationtools_year.png", p, width = 240, height = 100, units = "mm")
```

```{r}
df_code_available <- df |>
  mutate(Code.availability = strsplit(as.character(Code.availability), ", ")) |>
  tidyr::unnest(Code.availability)

p <- barplot_counts(df_code_available, "Code.availability")
p
ggsave("images/codeavailable_year.png", p, width = 240, height = 100, units = "mm")
```

```{r}
df_data_available <- df |>
  mutate(Data.Availability = strsplit(as.character(Data.Availability), ", ")) |>
  tidyr::unnest(Data.Availability)

p <- barplot_counts(df_data_available, "Data.Availability")
p
ggsave("images/dataavailable_year.png", p, width = 240, height = 100, units = "mm")
```
```{r}
#df <- read.csv("tagged_literature.csv")
#df |>
#  mutate(Automation.Tools = strsplit(as.character(Automation.Tools), ", ")) |>
#  tidyr::unnest(Automation.Tools) |>
#  pull(Automation.Tools) |> sort() |> unique()
```
```{r}
#df <- read.csv("tagged_literature.csv")
#df |>
#  mutate(Analysis.Methods = strsplit(as.character(Analysis.Methods), ", ")) |>
#  tidyr::unnest(Analysis.Methods) |>
#  pull(Analysis.Methods) |> sort() |> unique()
```
```{r}
df_eval <- df |>
  mutate(Evaluation.Method = strsplit(as.character(Evaluation.Method), ", ")) |>
  tidyr::unnest(Evaluation.Method)

df_eval <- keep_gt1(df_eval, "Evaluation.Method")
  #filter(Analysis.Methods %in% methods_to_keep)
p <- barplot_counts(df_eval, "Evaluation.Method")
p
ggsave("images/evaluationmethod_year.png", p, width = 240, height = 100, units = "mm")
```
```{r}
#df <- read.csv("tagged_literature.csv")
#df |>
#  mutate(Preprocessing = strsplit(as.character(Preprocessing), ", ")) |>
#  tidyr::unnest(Preprocessing) |>
#  pull(Preprocessing) |> sort() |> unique()
```
```{r}
df_pre <- df |>
  mutate(Preprocessing = strsplit(as.character(Preprocessing), ", ")) |>
  tidyr::unnest(Preprocessing)

df_pre <- keep_gt1(df_pre, "Preprocessing")
  #filter(Analysis.Methods %in% methods_to_keep)
p <- barplot_counts(df_pre, "Preprocessing")
p
ggsave("images/preprocessing_year.png", p, width = 240, height = 100, units = "mm")
```
```{r}
count_data <- df_lang |>
    group_by(Year, ProgLanguage, .drop=FALSE) |>
    summarise(Count = n(), .groups = 'drop') |>
    na.omit()
  
total_count_per_year <- count_data |>
  group_by(Year, .drop=FALSE) |>
  summarise(Total = sum(Count), .groups = 'drop')

count_data <- left_join(count_data, total_count_per_year, by = "Year") |>
  mutate(Percentage = (Count / Total) * 100) |>
  include_missing_zero('ProgLanguage')

count_data |> 
  ggplot(aes(x = factor(Year), y = Count, fill = ProgLanguage)) +
  geom_bar(stat = "identity", colour=ifelse(count_data$Count > 0, "black", NA)) +
  labs(x = "Year", y = "Count", fill = 'Language') +
  scale_y_continuous(expand=c(0,0))+
  theme_minimal() +
  guides(fill = guide_legend(override.aes = list(colour = "black")))+
  theme(panel.grid.major.x = element_blank(),
        panel.grid.major.y = element_line(colour = "grey80"),
        axis.line.x = element_line(colour="black"),
        #panel.grid = element_line(colour="lightgrey"),
        axis.ticks.x=element_line())
```

